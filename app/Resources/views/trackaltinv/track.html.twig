{%extends '::base.html.twig'%}

{% block stylesheets_extra %} 
<style>
#table1 tr:first-child td td:first{
    background-color: #DDD;
    font-size: 14px;
    font-weight: 400;
    color: #666;
    
}
#table1 td input{
    max-width: 100px;
}
</style>
{% endblock %}


{% block body %}

    <div class="row">
    <div id="table1" class="table-responsive col-lg-9">
        <form id="calx_form">
            <table class="table table-striped table-bordered table-hover">
             <thead>
                                    <tr>
                                        <td>&nbsp;</td>
                                        <td style="width: 3%">@</td>
                                        <td class="chead">A</td>
                                        <td class="chead">B</td>
                                        <td class="chead">C</td>
                                        <td class="chead">D</td>
                                        <td class="chead">E</td>
                                        <td class="chead">F</td>
                                        <td class="chead">G</td>
                                        <td class="chead">H</td>
                                        <td class="chead">I</td>
                                        <td class="chead">J</td>
                                        <td class="chead">K</td>
                                        <td class="chead">L</td>
                                        <td class="chead">M</td>
                                    </tr>
            </thead>
            
            
        </table>
     </form>       
    </div>

    <div class="col-lg-3">
       <!-- BEGIN SAMPLE FORM PORTLET-->
            <div class="portlet light bordered">
                <div class="portlet-title">
                    <div class="caption font-red-sunglo">
                        <i class="fa fa-plus" style="color:#E26A6A;"></i>
                        <span class="caption-subject bold uppercase"> New Register</span>
                    </div>
                </div>
                <div class="portlet-body form">
                    {{ form_start(form) }}
                    {{ form_widget(form) }}
                    <br>
                    <button type="button" class="btn default"  id="clear">Clear</button>
   
                    <button id="btn_addfield" type="submit" class="btn blue">Add Financial Field</button>
                 
                    {{ form_end(form) }}
                    <br>
                    <div class="form-actions">
                    </div>
                </div>
            </div>
            <!-- END SAMPLE FORM PORTLET-->
        </div>
      
        <br><br>

    </div>
    <div>
{%endblock%}

{% block javascripts_extra %} 
    
    <script>
        
         
    
    function formula(matriz){
          return x
    }
    
        //function que quita la mascara de moneda a una casilla solamente

    function quitar_moneda_casilla(elemento){
        elemento.val(elemento.val().replace('$', '' ));
    }
    
    //function que quita la mascara de moneda
    function quitar_moneda(){
         $(".table tr td input").each(function(index){
                $(this).val($(this).val().replace('$', '' ));
            });
        }
    
    //function que hace la mascara de moneda
    function poner_moneda(){
         $(".table tr td input").each(function(index){
        quitar_moneda_casilla($(this));    
        if( $(this).val().substr(0,1) != '=' ) {
                $(this).val("$"+ $(this).val());
            }else{
                //quitar_moneda($(this));
            }
                
        });
        
    }
    
    /*funcion que elabora matriz de totales*/
    function totales(){
                 var matriz = [];
                 var lastrow=$(".table tr:last td:first").text()-2;
                 for(i=2;i<lastrow;i++){
                  for(j=0;j<12;j++){
                      var casilla=String.fromCharCode(65+j)+i;
                          matriz.push(localStorage.getItem(casilla));
                       }
                 }
          console.log(matriz);
          
          //generando totales
          
          $(".table tr:last td").each(function(index){
               var letra_col=String.fromCharCode(65+index);
             //  var casilla_neg=letra_col+(lastrow);//la casilla de total negativo
             //  var casilla_pos=letra_col+(lastrow+1);//la casilla de total positivo
               var casilla_total=letra_col+(lastrow+2);//la casilla de total general
               var sigma='=';
               for(i=2;i<=lastrow;i++) sigma+="+"+letra_col+i;
               localStorage.setItem(casilla_total,sigma);
               $(this).trigger('click');
        });
               
            //poner_moneda();
         
          
          // agrego los simbnolos de dolar sNaN(parseFloat(value)) ? value : "$"+parseFloat(value) ;
          
          
          
          
          //calcular las formulas desde el storage recursivamente
        /*var filas=lastrow-2;
           for(c=0;c<13;c++){//recorro las columnas y las sumo
            var total_col=0;
              for(f=0;f<filas;f++){
                total_col+=parseFloat(matriz[c+f*12]);
              }
              var casilla=String.fromCharCode(65+c)+"6";
              $("span#"+casilla).html('<strong>'+ parseFloat(total_col)+'</strong>');
        }//fin recorro las col
          */
          
        /*
        $(".table tr").each(function(i) {
            
            var arrayOfThisRow = [];
            var tableData = $(this).find('td');
            tableData.each(function(j) { 
            var casilla=String.fromCharCode(65+i)+j;
            
             arrayOfThisRow.push( localStorage.getItem(casilla) );
            });
              myTableArray.push(arrayOfThisRow);
        });

            console.log(myTableArray);
*/       
        }//fin totales
       
        
        
        var objects='{{ objects}}'; // viene del controlador

        jsonStr = objects.replace(/&quot;/g, '"'); //arreglar comillas dobles
        var obj = JSON.parse(jsonStr); //convertir a jsonArray
        console.log(obj);
    /*for (var i = 0; i <= obj.length; i++){
                obj.splice(i,1); 
        }
*/
        var months =['','Jan','Feb','Mar','Apr','May', 'Jun', 'Jul', 'Ago','Sep', 'Oct', 'Nov','Dic'];
        var fila='<tr><td></td>';
        for (var j = 0; j < 13; j++) { //cols
            fila+='<td>'+months[j]+'</td>';
        }
        fila+='<td>Total</td></tr>';
        $('.table').append(fila);
        fila='';

        //ahroa elcontenido
        
        for (var i = 1; i < obj.length; i++) { //rows
            fila+='<tr></td><td>'+i+'</td><td>'+obj[i-1].description+'';
            //+'&nbsp;&nbsp;&nbsp;&nbsp';
            
                    for (var j = 0; j < 12; j++) { //cols
                        var letter = String.fromCharCode("A".charCodeAt(0) +j);
                        var coord=letter + i;
                         fila+= '<td><input id='+obj[i].id +" data-cell="+coord+ ' data-format="$ 0,0[.]00">\n\
                                 <input type="hidden" value="" class="'+coord+'"></td>' ;
                    }
            fila+='<td><input data-cell="+M' + i+'"  data-formula="SUM(A'+i+':L'+i+')" data-format="$ 0,0[.]00"></td></tr>';
             $('.table').append(fila);
             fila='';

        }
        
       /*var k=0;
       var total_label=Array();
       total_label[0]= 'Total Income';
       total_label[1]= 'Total Outcome';
       total_label[2]= 'Total ';
       
        for (var i = obj.length+2; i<obj.length+5; i++) { //rows
            var row = document.querySelector("table").insertRow(-1);
            row.insertCell(-1).outerHTML = '<strong>'+total_label[k]+'&nbsp;&nbsp;&nbsp;&nbsp; </strong>';
            k++;
            for (var j = 0; j <= 13; j++) { //cols
                var letter = String.fromCharCode("A".charCodeAt(0) + j - 1);
                row.insertCell(-1).innerHTML = i && j? "<strong><input id='" + letter + i + "'/></strong>" : i || letter;
            }
            
            
        }*/
        //agregando SubTotal outcome
        //agregando SubTotal income
        //agregando Total income-outcome
        /**cuando cambia una celda guardo en BD***/
        //  $.post( "{#{ path('ajax_trackaltinv_create') }#}",{
                                                    //mes:elm.id.charCodeAt(0)-64, 
                                                    //valor:elm.value, 
                                                    //id_altinv: {#{app.request.attributes.get('id')}#}, 
                                                    //id_fieldsaltinv:$("input#"+elm.id).attr('param') 
           // });
            /*****/

        //poner_moneda();
        
 $( document ).ready(function() {
      $("td input").css("text-align","right");
      $("td input").css("border","none");
               
      $('form#calx_form').calx({
                onBeforeCalculate : function(){
                   
                },
                onAfterRender : function(){
                    
                },
            
            });
       
     
        totales();
        
        
            //$('input.'+id).val('='+formula);
            //$('input.'+id).attr('data-formula',formula);
            //$(this).attr('data-formula',formula);
            //$('input.'+id).calx('evaluate', formula);
         $('td input').focusout(function(){
        var coord=$(this).attr('data-cell');
        var fila=coord.substr(0,1);
        alert(coord);
        var casilla=$(this).val();
         if(casilla.charAt(0)=='='){//es formula
            var formula=casilla.substr(1,casilla.length);
            $('input.'+coord).val('='+formula);
             if($('form#calx_form').calx('getSheet')){
                $('form#calx_form').calx('getCell', coord)
                            .setFormula(formula)
                            .calculate()
                            .renderComputedValue();
                }//fin si get hoja    
            }else{
            $('input.'+coord).val(casilla);
             //debo recalcular los totales tb
          /*  $('form#calx_form').calx('getCell', "M"+fila)
                            .setFormula('SUM(A'+fila+':L'+fila)
                            .calculate()
                            .renderComputedValue();*/
            }//fin si es formula
        
        
    });
    
        $('#btn_addfield').click(function(e) {
                 e.preventDefault();
                desc=$("#fields_altinv_description").val();
                wg=$("#fields_altinv_widget option:selected").val();
                 $.post( "{{ path('ajax_fieldstrackaltinv_create') }}",{ description: desc, widget: wg, id_altinv: {{app.request.attributes.get('id')}}})
                         .done(function( resp){
                              $('form[name="{{ form.vars.name }}"]').trigger("reset");
                            location.reload();
                          });
                });
        
        
        $('#clear').click(function() {
                 $('form[name="{{ form.vars.name }}"]').trigger("reset");
                 $('span').removeClass("checked");
             });
             
             
             $("select#fields_altinv_widget").val('Currency');
             $("select#fields_altinv_widget").hide();
             $("label[for=fields_altinv_widget] ").hide();
             $(".numeric").numeric({ decimal : ".",  negative : false, scale: 4 });
               $(".currency").maskMoney();
               
               //$("td").css("text-align","right");
               $("textarea").css("border","none");
               $("td input").css("text-align","right");
               $("td input").css("border","none");
               
               /*cuando cambie un input guardo en Base de datos track col = date month*/
              $("td input").focusout(function() {
                var mes=$(this).prop('id').charCodeAt(0)-64; //obtengo el mes Enero=1
                var field=$(this).attr('param');
                //quitar_moneda();
                //poner_moneda();
                 
                });
                
                   $("td input").click(function() {
                        quitar_moneda();
                });
 });
    </script>
{% endblock %}

